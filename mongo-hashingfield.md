 
**MongoDb: uniqueness over array field**

Problem Statement:
we faced a challenge while maintaining uniqueness in the array field for documents.
Suppose below is the document structure:
<pre>
{
  "_id": "6508298620ce172316795b0d",
...
  "arrayXYZ": [
    {
      "x": "valueX1",
      "y": "valueX2",
      "z": "valueX",
      "name": "valueX",
      "role": "valueX"
    },{
      "x": "valueY1",
      "y": "valueY2",
      "z": "valueY",
      "name": "valueY",
      "role": "valueY"
    },{
      "x": "valueZ1",
      "y": "valueZ2",
      "z": "valueZ",
      "name": "valueZ",
      "role": "valueZ"
    }
  ]
...
}
</pre>
We wanted to make sure that the "arrayXYZ" array (considering only "x", "y") is unique across the database and also wanted to have a query based on the "arrayXYZ" array.
i.e., to query documents by the exact match of the input array with partial fields
- [{“valueX1”, “valueX2”},{“valueY1”, “valueY2”},{“valueZ1”, “valueZ2”}]
The available solution on Mongo index on arrays works on elements of the array, not the whole array.
So we can’t have a unique index in arrayXYZ array.
 
**Solution:**
  ![image](https://github.com/nsingh5/mongo/assets/10362252/e8e39bb7-0019-4d5a-b278-b7cf282436d3)

To resolve this,
We created a field with "arrayXYZHash", which is generated by all the array elements.

    
This field gets calculated on the application side for each creation or update of a document in MongoDB using (x, y) fields.

Now, the application takes a list of List<arrayXYZ> objects in a sorted way and applies the hashing algorithm, thus creating arrayXYZHash for each document.

This makes sure the generated arrayXYZHash will be unique for an array of elements.

<pre>
{
  "_id": "6508298620ce172316795b0d",
...
  "arrayXYZ": [...],
  "arrayXYZHash": "B6CDDB3CCD6B50D8C482E1676F7844A1B2AFB29058ADA0F460D89C26DDF28EFC"
  }
 </pre>

Now we can create a unique index on this field (arrayXYZHash) on the MongoDB side.
 <pre>
public void init() {
       
 }
 public String generateHash(String key) {
 md = this.getMessageDigest("SHA-256");
byte[] hashBytes = md.digest(key.getBytes(StandardCharsets.UTF_8));
}
// here key value returned by below function, which is sorted values of array

// calculate hash while saving Document to Db
...
// save document to db
...
}
 </pre>
To find documents by the exact match of the input array, the application-service uses the same logic to generate arrayXYZHash and search documents by arrayXYZHash.

  <pre>
  // calculate hash while searching Document to Db
generateHash(key);
...
// get document from db using hash
documentRepository.findByHash(hash);
...
}

# find by mongoQuery
//find documents by arrayXYZHash
db.inventory.find( {"arrayXYZHash": "B6CDDB3CCD6B50D8C482E1676F7844A1B2AFB29058ADA0F460D89C26DDF28EFC"}})

  </pre>
With this approach, we can add uniqueness to the array field, and searching will be very fast with the help of an index.
Along with this, if we need to search a document based on an element of an array, We can create a multi-index on the array field and use the below queries:
- db.inventory.find({"arrayXYZ":  {$elemMatch: {  "x":"valueX1", "y":"valueX2"}}})
 
**Conclusion:**
MongoDB does not support uniqueness over array fields; to achieve this requirement, a new field can be used that helps to maintain uniqueness.
This approach is not limited to having uniqueness in an array; we can use it in other scenarios where MongoDB does not support any operations by default but application-side logic can be used.





========================

find documents by exact match of input array 
//Q1- does exact match but specified order should be same as document  
- db.inventory.find( { tags: ["red", "blank"] } )

//Q2- finds array that contains both the elements, It may contain other elements too
- db.inventory.find( {"arrayXYZ": {$all: [ {$elemMatch: {  "x":'Bi', y:1834123}},{$elemMatch: {  "x":'C', y:5689234}}]}})

//Q3- we can compare size along with above query,that will give exact match of array without worrying about order
- db.inventory.find( {"arrayXYZ": {"$size" : 2,$all: [ {$elemMatch: {  "x":'B', y:1834123}},{$elemMatch: {  "x":'C', y:5689234}}]}})


above query does exact match but specified order should be same as document , it does not support match partial fields
- collection.find(all("tags", asList("red", "blank")));
above find an array that contains both the elements "red" and "blank", without regard to order or other elements in the array

